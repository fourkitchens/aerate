<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="{{application}} {{version}}" />
    <meta name="description" content="Sift results for {{date}}" />

    <title>Sift</title>

    <link rel="stylesheet" href="mapper/siftmap/css/style.css" media="all" />
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/britecharts@2.0.0/dist/css/britecharts.min.css">
    <link href="https://fonts.googleapis.com/css?family=Arimo|Poiret+One|Source+Code+Pro" rel="stylesheet">
  </head>
  <body>
    <h1>Sift</h1>
    <div class="content">
      <ul class="menu">
        {{#each results}}
          <li><a href="#{{ this.name }}">{{ this.name }} {{ this.type }}</a></li>
        {{/each}}
      </ul>

      <div id="britecharts">
        {{#each results}}
          <div class="britechart-test" id="{{ this.name }}">
            <h2 class="britechart-test__header">{{ this.name }} {{ this.type }}</h2>
          {{#each firstView}}
            <div class="chart chart--{{ @key }}">
              <div class="chart__meta">
                <h2 class="chart__title">{{ this.testName }}</h2>
                <p class="chart__description">{{ this.testDescription }}</p>
                <span class="chart__stats">Budget:<span class="chart__budget"></span></span>
                <span class="chart__stats">Results:<span class="chart__results"></span></span>
                <span class="chart__stats"><span class="chart__passed">Passed</span></span>
              </div>
              <div class="chart__data">
                <div class="chart__barchart"></div>
                <span class="chart__label">milliseconds</span>
              </div>
            </div>
            {{/each}}
          </div>
        {{/each}}
      </div>

    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.10.0/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/britecharts/2.0.0/bundled/britecharts.min.js"></script>
    <script>
    var tests = {{{json tests}}};
    console.log(tests);
    for (var i = 0, len = tests.length; i < len; i++) {
      var newBarChart = tests[i];
      for (var i = 0, len = newBarChart.length; i < len; i++) {
        var briteElement = document.querySelectorAll('.chart');
        var briteChart = briteElement[i];
        var briteElementChart = briteElement[i].querySelectorAll('.chart__barchart');
        var budgetData = newBarChart[i];

        // Data (budget)
        var budgetSpan = briteElement[i].querySelectorAll('.chart__budget');
        if (budgetData[1].percentage !== null) {
          budgetSpan[0].textContent = ' ' + budgetData[1].percentage + 'ms';
        }
        else {
          budgetSpan[0].textContent = ' NA';
        }

        // Data (results)
        var resultsSpan = briteElement[i].querySelectorAll('.chart__results');
        resultsSpan[0].textContent = ' ' + budgetData[0].percentage + 'ms';

        // Britecharts
        var colors = ['#ffce00', '#6aedc7'];
        if (budgetData[1].class.length > 0) {
          briteElement[i].classList.add(budgetData[1].class);

          if (budgetData[1].class == 'single-data') {
            resultsSpan[0].textContent = ' ' + budgetData[0].percentage;
          }

          if (budgetData[1].class == 'over-budget') {
            colors = ['#ffce00', '#f55573'];

            var statusSpan = briteElement[i].querySelectorAll('.chart__passed');
            statusSpan[0].textContent = ' Failed';
          }
        }

        function createHorizontalBarChart() {
          let tooltip = new britecharts.miniTooltip();
          let barChart = new britecharts.bar(),
              margin = {
                left: 80,
                right: 20,
                top: 20,
                bottom: 30
              },
              barContainer = d3.select(briteElementChart[0]),
              containerWidth = barContainer.node() ? barContainer.node().getBoundingClientRect().width : false;

          if (containerWidth) {
            barChart
               .isHorizontal(true)
               .margin(margin)
               .width(containerWidth)
               .colorSchema(colors)
               .valueLabel('percentage')
               .isAnimated(true)
               .percentageAxisToMaxRatio(1.2)
               .height(200)
               .on('customMouseOver', tooltip.show)
               .on('customMouseMove', tooltip.update)
               .on('customMouseOut', tooltip.hide);

            barContainer.datum(budgetData).call(barChart);
          }

          var tooltipItem = briteElement[i].querySelectorAll('.metadata-group');
          tooltipContainer = d3.select(tooltipItem[0]);
          tooltipContainer.datum([]).call(tooltip);

          // Responsive
          const redrawChart = () => {
            var allCharts = document.querySelectorAll('.chart__barchart');
            let container = d3.select(allCharts[i]);
            let newContainerWidth = container.node() ? container.node().getBoundingClientRect().width : false;

            // Setting the new width on the chart
            barChart.width(newContainerWidth);

            // Rendering the chart again
            container.datum(budgetData).call(barChart);
          };

          window.addEventListener("resize", redrawChart);
        }
        createHorizontalBarChart();
      }
    }
    </script>
  </body>
</html>
