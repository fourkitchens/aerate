<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="{{application}} {{version}}" />
    <meta name="description" content="Sift results for {{date}}" />

    <title>Sift</title>

    <link rel="stylesheet" href="mapper/sift/css/style.css" media="all" />
    <link type="text/css" rel="stylesheet" href="node_modules/britecharts/dist/css/britecharts.min.css">
    <link href="https://fonts.googleapis.com/css?family=Arimo|Poiret+One|Source+Code+Pro" rel="stylesheet">
  </head>
  <body>
    <h1>Sift</h1>
    <div class="content">
      <!-- <ul class="menu">
        <li><a href="#summary">Summary</a></li>
        <li><a href="#charts">Charts</a></li>
        <li><a href="#optimisations">Optimisations</a></li>
      </ul> -->

      <div id="britecharts">
        {{#each budget}}
        <div class="chart">
          <div class="chart__meta">
            <h2 class="chart__title">{{ this.name }}</h2>
            <p class="chart__description">{{ this.description }}</p>
          </div>
          <div class="chart__data">
            <div class="chart__barchart"></div>
            <span class="chart__label">milliseconds</span>
          </div>
        </div>
        {{/each}}
      </div>

    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.10.0/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/britecharts/2.0.0/bundled/britecharts.min.js"></script>
    <script>
    var newMap = {{{json newMap}}};
    for (var i = 0, len = newMap.length; i < len; i++) {
      var briteElement = document.querySelectorAll('.chart');
      var briteChart = briteElement[i];
      var briteElementChart = briteElement[i].querySelectorAll('.chart__barchart');
      var budgetData = newMap[i];
      var colors = ['#ffce00', '#6aedc7'];
      if (budgetData[1].class.length > 0) {
        briteElement[i].classList.add('over-budget');
        colors = ['#ffce00', '#f55573'];
      }

      function createHorizontalBarChart() {
        let tooltip = new britecharts.miniTooltip();
        let barChart = new britecharts.bar(),
            margin = {
              left: 80,
              right: 20,
              top: 20,
              bottom: 30
            },
            barContainer = d3.select(briteElementChart[0]),
            containerWidth = barContainer.node() ? barContainer.node().getBoundingClientRect().width : false;

        if (containerWidth) {
          barChart
             .isHorizontal(true)
             .margin(margin)
             .width(containerWidth)
             .colorSchema(colors)
             .valueLabel('percentage')
             .isAnimated(true)
             .percentageAxisToMaxRatio(1.2)
             .height(200)
             .on('customMouseOver', tooltip.show)
             .on('customMouseMove', tooltip.update)
             .on('customMouseOut', tooltip.hide);

          barContainer.datum(budgetData).call(barChart);
        }

        var tooltipItem = briteElement[i].querySelectorAll('.metadata-group');
        tooltipContainer = d3.select(tooltipItem[0]);
        tooltipContainer.datum([]).call(tooltip);

        // Responsive
        const redrawChart = () => {
          var allCharts = document.querySelectorAll('.chart__barchart');
          let container = d3.select(allCharts[i]);
          let newContainerWidth = container.node() ? container.node().getBoundingClientRect().width : false;

          // Setting the new width on the chart
          barChart.width(newContainerWidth);

          // Rendering the chart again
          container.datum(budgetData).call(barChart);
        };

        window.addEventListener("resize", redrawChart);
      }
      createHorizontalBarChart();
    }
    </script>
  </body>
</html>
